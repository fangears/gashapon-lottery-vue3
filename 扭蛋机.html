<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matter.js 物理扭蛋机</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --machine-color: #ff8e8e;
            --machine-dark: #d65c5c;
            --glass-border: rgba(255, 255, 255, 0.4);
            --bg-color: #fce4ec;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--bg-color);
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* 扭蛋机主体容器 */
        #gacha-machine {
            position: relative;
            width: 360px;
            height: 520px;
            background: var(--machine-color);
            border-radius: 40px 40px 20px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 -10px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }

        /* 顶部装饰 */
        .top-lid {
            width: 150px;
            height: 30px;
            background: var(--machine-dark);
            border-radius: 20px 20px 0 0;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
        }

        /* 玻璃视窗区域 */
        #canvas-container {
            width: 300px;
            height: 300px;
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border: 8px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 10px 30px rgba(0,0,0,0.1);
            background: radial-gradient(circle at 70% 30%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.1) 20%, rgba(255,255,255,0) 60%);
        }

        /* 控制面板区域 */
        .controls {
            width: 100%;
            height: 180px;
            position: relative;
            margin-top: 10px;
        }

        /* 旋钮按钮 */
        #knob-btn {
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            border: none;
            box-shadow: 0 6px 0 #ccc, 0 10px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.1s;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #knob-btn::after {
            content: "PUSH";
            font-weight: bold;
            color: var(--machine-dark);
            font-size: 16px;
        }

        #knob-btn::before {
            content: "";
            position: absolute;
            width: 90%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            z-index: -1;
            transform: rotate(90deg);
        }

        #knob-btn:active {
            box-shadow: 0 2px 0 #ccc, 0 4px 4px rgba(0,0,0,0.2);
            transform: translateX(-50%) translateY(4px);
        }

        #knob-btn.rotating {
            animation: rotateKnob 0.5s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes rotateKnob {
            0% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(20deg); }
            75% { transform: translateX(-50%) rotate(-20deg); }
            100% { transform: translateX(-50%) rotate(0deg); }
        }

        /* 出奖口容器 */
        .exit-gate {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 70px;
            height: 70px;
            background: #333;
            border-radius: 10px 10px 30px 10px;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.5);
            /* 关键：隐藏溢出，实现"掉入"效果 */
            overflow: hidden; 
            z-index: 5;
        }
        
        .exit-gate::after {
            content: "EXIT";
            color: #666;
            font-size: 10px;
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* 确保文字在球上面 */
        }

        /* 遮罩层 (用于展示结果时变暗背景) */
        #overlay-mask {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            z-index: 99; /* 遮罩层层级 */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #overlay-mask.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- 复杂的奖品球样式 --- */
        .gacha-ball {
            position: absolute;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            /* 初始位置：在出奖口上方不可见区域 */
            top: -60px; 
            left: 12px;
            z-index: 1;
            transform-style: preserve-3d;
            /* 移除这里的默认 transition，在 JS 中动态控制以实现精准切换 */
        }

        /* 球的上半部分 (颜色) */
        .ball-half {
            position: absolute;
            width: 100%;
            height: 50%;
            left: 0;
            box-sizing: border-box;
            border: 2px solid rgba(0,0,0,0.1);
            background: var(--ball-color, #ff6b6b);
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
            z-index: 2;
        }

        .ball-half.top {
            top: 0;
            border-radius: 23px 23px 0 0;
            border-bottom: none;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent), var(--ball-color);
        }

        .ball-half.bottom {
            bottom: 0;
            border-radius: 0 0 23px 23px;
            border-top: 1px solid rgba(0,0,0,0.1);
            background: white; /* 下半球通常是白色的 */
        }

        /* 中奖纸条 */
        .prize-paper {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: #fffdf0;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: bold;
            color: #d65c5c;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 0; /* 初始隐藏文字 */
            overflow: hidden;
            transition: all 0.5s 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1;
            border: 2px solid #e0c090;
            padding: 0;
        }

        /* --- 开球状态 --- */
        .gacha-ball.open .ball-half.top {
            transform: translateY(-40px) rotate(-15deg);
            opacity: 0.8;
        }
        .gacha-ball.open .ball-half.bottom {
            transform: translateY(40px) rotate(15deg);
            opacity: 0.8;
        }

        .gacha-ball.open .prize-paper {
            width: 140px;
            height: 80px;
            font-size: 16px;
            padding: 10px;
            z-index: 10; /* 确保纸条在打开后位于最高层，且在遮罩之上 */
        }

        /* 关闭按钮 */
        .reset-btn {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%) scale(0.8); /* 缩小为0.8 */
            padding: 8px 20px;
            background: white;
            color: #333;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            white-space: nowrap;
            z-index: 20; /* 确保在纸条之上 */
        }
        .gacha-ball.open .reset-btn {
            opacity: 1;
            bottom: -80px; /* 原来是-60px，下移20px */
        }

    </style>
</head>
<body>

    <div id="overlay-mask"></div>

    <div id="gacha-machine">
        <div class="top-lid"></div>
        
        <!-- 物理引擎画布容器 -->
        <div id="canvas-container"></div>
        
        <div class="controls">
            <!-- 出奖口 -->
            <div class="exit-gate"></div>
            
            <!-- 扭蛋按钮 -->
            <button id="knob-btn" onclick="startGacha()"></button>
        </div>
    </div>

    <script>
        // --- Matter.js 设置 (保持之前的优化配置) ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Body = Matter.Body;

        const engine = Engine.create({ positionIterations: 20, velocityIterations: 20 });
        const world = engine.world;
        const width = 300, height = 300;

        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width, height, background: 'transparent', wireframes: false }
        });

        // 墙壁生成
        const centerX = width/2, centerY = height/2, radius = 145, wallThickness = 150, segments = 50;
        for (let i = 0; i < segments; i++) {
            const angle = (i / segments) * Math.PI * 2;
            const dist = radius + wallThickness/2;
            const wall = Bodies.rectangle(
                centerX + Math.cos(angle) * dist,
                centerY + Math.sin(angle) * dist,
                (2 * Math.PI * dist) / segments * 1.1,
                wallThickness,
                { isStatic: true, angle: angle + Math.PI/2, render: { fillStyle: 'transparent' } }
            );
            Composite.add(world, wall);
        }

        // 内部挡板
        Composite.add(world, Bodies.circle(width/2, height/2 + 50, 30, { 
            isStatic: true, render: { fillStyle: 'rgba(255,255,255,0.2)' } 
        }));

        // 球体生成
        const ballColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7D794'];
        const balls = [];
        
        function addBalls(count) {
            for (let i = 0; i < count; i++) {
                const color = ballColors[Math.floor(Math.random() * ballColors.length)];
                const ball = Bodies.circle(
                    width/2 + (Math.random()-0.5)*50, 
                    height/2 + (Math.random()-0.5)*50, 
                    18, 
                    {
                        restitution: 0.8, friction: 0.005, frictionAir: 0.05,
                        render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 3 }
                    }
                );
                balls.push(ball);
            }
            Composite.add(world, balls);
        }
        addBalls(20);

        // 速度限制
        Events.on(engine, 'beforeUpdate', () => {
            balls.forEach(b => {
                if (b.speed > 15) Body.setVelocity(b, { x: b.velocity.x * (15/b.speed), y: b.velocity.y * (15/b.speed) });
            });
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);

        // --- 游戏逻辑 ---
        let isSpinning = false;
        
        function startGacha() {
            if (isSpinning) return;
            isSpinning = true;

            const btn = document.getElementById('knob-btn');
            btn.classList.add('rotating');

            const mixInterval = setInterval(() => {
                balls.forEach(ball => {
                    const angle = Math.random() * Math.PI * 2;
                    Body.applyForce(ball, ball.position, { 
                        x: Math.cos(angle) * 0.035, y: Math.sin(angle) * 0.035 - 0.005 
                    });
                });
            }, 100);

            setTimeout(() => {
                clearInterval(mixInterval);
                btn.classList.remove('rotating');
                dispensePrize();
            }, 2000);
        }

        function dispensePrize() {
            const gate = document.querySelector('.exit-gate');
            const color = ballColors[Math.floor(Math.random() * ballColors.length)];
            const prizeText = getPrizeName();

            // 1. 创建扭蛋结构
            const ballContainer = document.createElement('div');
            ballContainer.className = 'gacha-ball';
            ballContainer.style.setProperty('--ball-color', color);

            const topHalf = document.createElement('div');
            topHalf.className = 'ball-half top';
            const bottomHalf = document.createElement('div');
            bottomHalf.className = 'ball-half bottom';
            const paper = document.createElement('div');
            paper.className = 'prize-paper';
            paper.innerText = prizeText;
            const resetBtn = document.createElement('button');
            resetBtn.className = 'reset-btn';
            resetBtn.innerText = '收入囊中';
            resetBtn.onclick = (e) => {
                e.stopPropagation(); 
                resetGame(ballContainer);
            };

            ballContainer.appendChild(paper);
            ballContainer.appendChild(topHalf);
            ballContainer.appendChild(bottomHalf);
            ballContainer.appendChild(resetBtn);
            
            gate.appendChild(ballContainer);

            // 2. 掉落动画 (第一阶段：从机器内部掉到出奖口)
            ballContainer.style.transition = 'top 0.6s cubic-bezier(0.5, 0, 0.75, 0)';
            
            // 强制重绘
            ballContainer.getBoundingClientRect();
            
            ballContainer.style.top = '12px'; // 掉落到底部

            // 3. 静止后，执行位移动画 (第二阶段：出奖口 -> 屏幕中心)
            setTimeout(() => {
                animateToCenter(ballContainer);
            }, 800); 
        }

        function animateToCenter(ball) {
            // --- 第一帧 (Frame 1): 锁定当前位置 ---
            // 获取球体当前在出奖口的绝对坐标
            const rect = ball.getBoundingClientRect();
            
            // 将球体提升到 body 层级，并固定在当前坐标，防止因层级变化导致的跳动
            ball.style.position = 'fixed';
            ball.style.left = rect.left + 'px';
            ball.style.top = rect.top + 'px';
            ball.style.margin = '0';
            ball.style.zIndex = '100'; // 高于遮罩层
            
            // 关键：暂时移除 transition，确保从 DOM 变换到 fixed 定位是瞬时的
            ball.style.transition = 'none';
            
            document.body.appendChild(ball);

            // 关键：强制浏览器回流 (Reflow/Layout)，让浏览器渲染"第一帧"的位置
            // 如果没有这行，浏览器可能会合并后续的 style 更改，导致动画直接从 0,0 开始或没有动画
            void ball.offsetWidth;

            // 激活遮罩背景
            document.getElementById('overlay-mask').classList.add('active');

            // --- 尾帧 (Frame 2): 移动到中心并放大 ---
            // 启用平滑过渡
            ball.style.transition = 'all 0.8s cubic-bezier(0.25, 1, 0.5, 1)'; 
            
            ball.style.top = '50%';
            ball.style.left = '50%';
            // 使用 translate 修正居中，并 scale 放大
            ball.style.transform = 'translate(-50%, -50%) scale(3)';

            // --- 动画结束: 打开扭蛋 ---
            setTimeout(() => {
                ball.classList.add('open');
            }, 800); // 等待 0.8s 位移动画完成
        }

        function resetGame(ballElement) {
            // 移除球体
            ballElement.style.opacity = '0';
            ballElement.style.transform = 'translate(-50%, -50%) scale(0.5)'; // 缩小消失
            document.getElementById('overlay-mask').classList.remove('active');
            
            setTimeout(() => {
                if(ballElement.parentNode) ballElement.parentNode.removeChild(ballElement);
                isSpinning = false;
            }, 500);
        }

        function getPrizeName() {
            const prizes = ['特等奖\n豪华手办', '一等奖\n游戏机', '二等奖\n大抱枕', '三等奖\n钥匙扣', '纪念奖\n贴纸一张'];
            const r = Math.random();
            if (r < 0.05) return prizes[0];
            if (r < 0.15) return prizes[1];
            if (r < 0.35) return prizes[2];
            if (r < 0.65) return prizes[3];
            return prizes[4];
        }

    </script>
</body>
</html>